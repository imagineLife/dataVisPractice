<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MultiStackedBar</title>
    <style>
      #chart {
        position: absolute;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
      }
    </style>
  </head>
  <body>
    <div id="chart">
      <h1>Segments</h1>
    </div>
  </body>
  <script src="//d3js.org/d3.v4.min.js"></script>
  <script src="../../../../d3-selection-multi.min.js"></script>
  <script>

    // Build Variables
    const vars = {
      xLabel : 'Note Name',
      yLabel : 'Number Of Notes',
      margin : { left: 25, right: 70, top: 40, bottom: 110 }
    };

    //Add nodes to D3 selections
    const chartDiv = document.getElementById("chart");
    const svgObj = d3.select(chartDiv).append("svg");
    const width = +600 - vars.margin.left - vars.margin.right;
    const height = +500 - vars.margin.top - vars.margin.bottom;
    const  gObj = svgObj.append("g").attr("transform", "translate(" + vars.margin.left + "," + vars.margin.top + ")");

    // Extract the width and height that was computed by CSS.
    let resizedWidth = chartDiv.clientWidth;
    let resizedHeight = chartDiv.clientHeight;

    //set svg height & width
    svgObj.attrs({
      "width" : resizedWidth,
      "height" : resizedHeight
    });


    var xScale = d3.scaleBand()
        .padding(0.3)
        .align(0.3);

    var yScale = d3.scaleLinear()

    var colorScale = d3.scaleOrdinal(d3.schemeCategory20);

    var stack = d3.stack();

    d3.csv("data.csv", type, function(error, data) {
      if (error) throw error;

      data.sort(function(a, b) { return b.totalOfThisCategory - a.totalOfThisCategory; });

      xScale.domain(data.map(function(d) { return d.ethnicity; }));
      yScale.domain([0, d3.max(data, function(d) { return d.totalOfThisCategory; })]).nice();
      colorScale.domain(data.columns.slice(1));

      gObj.selectAll(".serie")
        .data(stack.keys(data.columns.slice(1))(data))
        .enter().append("g")
          .attrs({
            "class": "serie",
            "fill": function(d) { return colorScale(d.key); }
          })
        .selectAll("rect")
        .data(function(d) { return d; })
        .enter().append("rect")
          .attrs({
            "x": function(d) { return xScale(d.data.ethnicity); },
            "y": function(d) { return yScale(d[1]); },
            "height": function(d) { return yScale(d[0]) - yScale(d[1]); },
            "width": xScale.bandwidth()
          });

      const xAxisG = gObj.append("g")
          .attrs({
            "class": "axis axis--x",
            "transform": "translate(0," + height + ")"
          })
          .call(d3.axisBottom(xScale));

      const yAxisG = gObj.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(yScale).ticks(10, "s"))
        .append("text")
          .attrs({
            "x": 2,
            "y": yScale(yScale.ticks(10).pop()),
            "dy": "0.35em",
            "text-anchor": "start",
            "fill": "#000"
          })
          .text("Population");

      // var legend = gObj.selectAll(".legend")
      //   .data(data.columns.slice(1).reverse())
      //   .enter().append("g")
      //     .attrs({
      //       "class": "legend",
      //       "transform": function(d, i) { return "translate(0," + i * 20 + ")"; }
      //     })
      //     .style("font", "10px sans-serif");

      // legend.append("rect")
      //     .attrs({
      //       "x": width + 18,
      //       "width": 18,
      //       "height": 18,
      //       "fill": z
      //     })

      // legend.append("text")
      //     .attrs({
      //       "x": width + 44,
      //       "y": 9,
      //       "dy": ".35em",
      //       "text-anchor": "start"
      //     })
      //     .text(function(d) { return d; });
    });

    function type(d, i, columns) {
      //columns are the column header row

      for (i = 1, t = 0; i < columns.length; ++i){
        t += d[columns[i]] = +d[columns[i]];
      }

      d.totalOfThisCategory = t;
      return d;
    }

    let resize = () => {
      console.log('resizing!');

      // Extract the width and height that was computed by CSS.
      let resizedFnWidth = chartDiv.clientWidth;
      let resizedFnHeight = chartDiv.clientHeight;

      let resizedWidthLessMargins = resizedFnWidth - vars.margin.left - vars.margin.right;
      let resizedHeightLessMargins = resizedFnHeight - vars.margin.top - vars.margin.bottom;

      svgObj.attrs({
        "width" : resizedFnWidth,
        "height" : resizedFnHeight
      });
    
      //set xScale
      xScale.rangeRound([0, resizedWidthLessMargins])

      //set yScale
      yScale.rangeRound([resizedHeightLessMargins, vars.margin.top]);

    }

    d3.select(window).on('resize',resize);

    resize();
  </script>
  </body>
</html>